#!/usr/bin/env bash

set -euo pipefail

info() {
    printf "→ %s\n" "$*"
}

success() {
    printf "✓ %s\n" "$*"
}

skip() {
    printf -- "- %s\n" "$*"
}

warn() {
    printf "✗ %s\n" "$*" >&2
}

error() {
    warn "$*"
    exit 1
}

run_task() {
    local description=$1
    shift

    info "$description"
    if "$@" &>/dev/null; then
        success "$description"
        return 0
    fi

    warn "$description failed (continuing)"
    return 1
}

cleanup_docker() {
    if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
        run_task "Docker cleanup" docker system prune --volumes --all --force
    else
        skip "Docker cleanup (docker unavailable)"
    fi
}

cleanup_uv() {
    if command -v uv >/dev/null 2>&1; then
        run_task "uv cache cleanup" uv cache clean
        run_task "uv tool upgrade" uv tool upgrade --all
    else
        skip "uv maintenance (uv not installed)"
    fi
}

cleanup_pacman() {
    if ! command -v pacman >/dev/null 2>&1; then
        skip "pacman cleanup (pacman not installed)"
        return
    fi

    run_task "pacman cache cleanup" sudo pacman --noconfirm -Sc

    local -a orphans=()
    if mapfile -t orphans < <(pacman -Qtdq 2>/dev/null) && ((${#orphans[@]} > 0)); then
        run_task "pacman orphan removal" sudo pacman --noconfirm -Rns "${orphans[@]}"
    else
        skip "pacman orphan removal (none found)"
    fi
}

cleanup_paru() {
    if ! command -v paru >/dev/null 2>&1; then
        skip "paru cleanup (paru not installed)"
        return
    fi

    run_task "paru cache cleanup" paru --sudo sudo -Sc --noconfirm
}

main() {
    info "Starting maintenance tasks"

    # Core maintenance tasks from Makefile
    cleanup_docker
    cleanup_uv
    cleanup_pacman
    cleanup_paru

    success "Maintenance tasks completed"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            echo "Usage: $0 [--with-update] [--help]"
            echo ""
            echo "Options:"
            echo "  --with-update    Also run system update (paru/pacman)"
            echo "  --help, -h       Show this help message"
            exit 0
            ;;
        *)
            error "Unknown option: $1"
            ;;
    esac
done

main "$@"
