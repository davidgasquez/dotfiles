#!/usr/bin/env bash
set -euo pipefail

script_path="$(realpath -- "${BASH_SOURCE[0]}")"
dotfiles_dir="$(cd -- "$(dirname -- "${script_path}")/.." && pwd)"
prompt_file="${dotfiles_dir}/codex/prompts/commit.md"

worker() {
  local session=$1
  local prompt_file=$2
  local repo_root=$3

  local head_before
  head_before="$(git rev-parse HEAD 2>/dev/null || true)"

  local codex_status
  if codex -a never exec -C "${repo_root}" - < "${prompt_file}"; then
    codex_status=0
  else
    codex_status=$?
  fi

  local head_after
  head_after="$(git rev-parse HEAD 2>/dev/null || true)"

  echo
  printf "Repo: %s\n" "${repo_root}"
  printf "Codex exit: %s\n" "${codex_status}"
  echo

  local new_commits=0
  local notify_body="Codex finished. No new commits."
  if [[ -n ${head_before} && -n ${head_after} && ${head_before} != "${head_after}" ]]; then
    new_commits=1
    notify_body="Commits ready. Review & push?"

    echo "New commits:"
    git --no-pager log --oneline --decorate "${head_before}..${head_after}"
    echo
  fi

  if command -v notify-send >/dev/null 2>&1; then
    notify-send "aigcm" "${notify_body}" || true
  fi

  if command -v uwsm >/dev/null 2>&1; then
    uwsm app -- alacritty --hold --working-directory "${repo_root}" --command tmux attach -t "${session}" >/dev/null 2>&1 &
  else
    alacritty --hold --working-directory "${repo_root}" --command tmux attach -t "${session}" >/dev/null 2>&1 &
  fi

  if ((new_commits)); then
    local confirm
    read -r -p "Commit messages OK? Press Enter to push (anything else to skip): " confirm
    if [[ -z ${confirm} ]]; then
      git push
    else
      echo "Skipping push."
    fi
  else
    echo "No new commits created."
  fi

  echo
  read -r -p "Press Enter to close... " _
}

main() {
  if [[ ${1:-} == "--worker" ]]; then
    shift
    worker "$@"
    return 0
  fi

  local repo_root
  repo_root="$(git rev-parse --show-toplevel)"

  local session
  session="aigcm-$(date +%s)"
  tmux new-session -d -s "${session}" -c "${repo_root}" "${script_path}" --worker "${session}" "${prompt_file}" "${repo_root}"
  printf "Started %s (tmux). You will be prompted to push when Codex finishes.\n" "${session}"
}

main "$@"
