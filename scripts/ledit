#!/usr/bin/env bash
set -euo pipefail

TITLE="ledit"

require() {
    command -v "$1" >/dev/null 2>&1
}

sendshortcut() {
    local mods="$1"
    local key="$2"
    local result

    result="$(hyprctl dispatch sendshortcut "${mods}, ${key}, activewindow" 2>&1 | tr -d '\n')"
    if [[ "$result" != "ok" ]]; then
        notify-send -u critical "$TITLE" "sendshortcut failed: $result"
        exit 1
    fi
}

for cmd in hyprctl llm notify-send wl-copy wl-paste; do
    if ! require "$cmd"; then
        echo "$TITLE: missing required command: $cmd" >&2
        exit 1
    fi
done

sleep 0.05
sendshortcut CTRL C
sleep 0.05

INPUT="$(wl-paste --no-newline)"
if [[ -z "${INPUT}" ]]; then
    notify-send -u critical "$TITLE" "No text copied (is something selected?)"
    exit 1
fi

notify-send -u low -t 5000 "$TITLE" "Refabulating..."

OUTPUT="$(
    printf %s "$INPUT" | llm prompt -t ledit --no-log --no-stream
)" || {
    notify-send -u critical "$TITLE" "LLM failed"
    exit 1
}

if [[ -z "${OUTPUT}" ]]; then
    notify-send -u critical "$TITLE" "LLM returned empty output"
    exit 1
fi

printf %s "$OUTPUT" | wl-copy
sleep 0.05
sendshortcut CTRL V

notify-send -u low -t 1500 "$TITLE" "Done"
