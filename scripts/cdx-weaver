#!/usr/bin/env bash

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
AGENT_DIR="${REPO_ROOT}/codex/agents/cdx-weaver"

if [[ ! -d $AGENT_DIR ]]; then
  echo "Error: agent directory not found at $AGENT_DIR" >&2
  exit 1
fi

usage() {
  echo "Usage: $(basename "$0") [file|-]  (reads stdin when no file is provided or when using '-')" >&2
  exit 1
}

if (( $# > 1 )); then
  usage
fi

if (( $# == 1 )) && [[ $1 != "-" ]]; then
  if [[ ! -f $1 ]]; then
    echo "Error: file not found: $1" >&2
    exit 1
  fi
  CONTENT=$(cat "$1")
else
  if [ -t 0 ]; then
    usage
  fi
  CONTENT=$(cat)
fi

if [[ -z "${CONTENT//[[:space:]]/}" ]]; then
  echo "Error: no input provided" >&2
  exit 1
fi

# Wrap the content in XML tags
PROMPT=$(cat <<EOF
Enhance any given text by enriching it with relevant insights drawn from the Handbook notes.

<text>
${CONTENT}
</text>
EOF
)

# Run Codex in exec mode
env CODEX_HOME="$AGENT_DIR" \
  codex exec \
    --skip-git-repo-check \
    --color=never \
    "$PROMPT"
